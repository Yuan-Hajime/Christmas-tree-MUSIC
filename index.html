<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Luxurious Interactive Christmas Tree with Music</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Tangerine:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000500;
            background: radial-gradient(circle at center, #021a0f 0%, #000000 100%);
            font-family: 'Cinzel', serif;
            color: #d4af37;
            cursor: crosshair;
            user-select: none;
        }

        #ui-layer {
            position: absolute;
            bottom: 40px;
            left: 0;
            width: 100%;
            text-align: center;
            pointer-events: none;
            z-index: 5;
            transition: opacity 0.5s;
        }

        .title {
            font-size: 1.5rem;
            color: #d4af37;
            text-transform: uppercase;
            letter-spacing: 0.3em;
            margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.5);
        }

        .instruction {
            font-family: 'Times New Roman', serif;
            font-style: italic;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 5px;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.9);
            line-height: 1.5;
        }

        .state-indicator {
            font-size: 1.2rem;
            color: #FFD700;
            margin-top: 15px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }

        .click-hint {
            position: absolute;
            border: 1px solid #d4af37;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            transform: translate(-50%, -50%);
            animation: ripple 0.6s linear forwards;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes ripple {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(4); opacity: 0; }
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #d4af37;
            font-size: 1.2rem;
            text-align: center;
            z-index: 100;
        }

        /* Èü≥‰πêÊí≠ÊîæÂô®Ê†∑Âºè */
        #music-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 15px;
            border: 1px solid #d4af37;
            color: white;
            font-family: 'Cinzel', serif;
            backdrop-filter: blur(10px);
            min-width: 320px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        #music-player:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: #FFD700;
        }

        .player-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(212, 175, 55, 0.3);
            padding-bottom: 10px;
        }

        .player-header h3 {
            color: #d4af37;
            margin: 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .song-info {
            margin-bottom: 15px;
        }

        #song-title {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #song-progress {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #d4af37, #FFD700);
            transition: width 0.1s linear;
        }

        .player-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            margin-bottom: 15px;
        }

        .control-btn {
            background: rgba(212, 175, 55, 0.2);
            border: 1px solid #d4af37;
            color: #d4af37;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Cinzel', serif;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: #d4af37;
            color: #000;
            transform: translateY(-2px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        #play-btn {
            background: #d4af37;
            color: #000;
            font-weight: bold;
            padding: 10px 25px;
            flex-grow: 1;
            justify-content: center;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #volume-slider {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
        }

        #volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            border: 2px solid #000;
        }

        #volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #d4af37;
            cursor: pointer;
            border: 2px solid #000;
        }

        #volume-text {
            font-size: 0.8rem;
            color: #d4af37;
            min-width: 40px;
        }

        .song-list {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
            padding-top: 10px;
        }

        .song-item {
            padding: 8px 12px;
            border-radius: 8px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .song-item:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .song-item.active {
            background: rgba(212, 175, 55, 0.2);
            color: #FFD700;
            border-left: 3px solid #d4af37;
        }

        /* ÈöêËóèÊí≠ÊîæÂô®ÊåâÈíÆ */
        #toggle-player {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 99;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #d4af37;
            color: #d4af37;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        #toggle-player:hover {
            background: #d4af37;
            color: #000;
            transform: scale(1.1);
        }

        .player-hidden {
            transform: translateX(120%);
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="ui-layer">
        <div class="title">Interactive Particle Christmas</div>
        <div class="instruction">Move Mouse to Float | Click to Change Shape</div>
        <div class="instruction">State: <span id="state-text">Christmas Tree</span></div>
        <div class="instruction">Click Cycle: Tree ‚Üí Text ‚Üí Heart ‚Üí Explode ‚Üí Tree</div>
    </div>
    
    <div id="loading">Loading Christmas Magic...</div>
    <div id="canvas-container"></div>

    <!-- Èü≥‰πêÊí≠ÊîæÂô®ÂàáÊç¢ÊåâÈíÆ -->
    <div id="toggle-player" title="ÊòæÁ§∫/ÈöêËóèÈü≥‰πêÊí≠ÊîæÂô®">üéµ</div>

    <!-- Èü≥‰πêÊí≠ÊîæÂô® -->
    <div id="music-player" class="player-hidden">
        <div class="player-header">
            <h3><span>üéµ</span> Âú£ËØûÈü≥‰πêÊí≠ÊîæÂô®</h3>
            <button id="close-player" class="control-btn" style="padding: 5px 10px; font-size: 0.9rem;">‚úï</button>
        </div>
        
        <div class="song-info">
            <div id="song-title">Ê≠£Âú®Êí≠ÊîæÔºöJingle Bells</div>
            <div id="song-progress">
                <div id="progress-bar"></div>
            </div>
            <div id="time-display" style="font-size: 0.8rem; color: rgba(255,255,255,0.6); display: flex; justify-content: space-between;">
                <span id="current-time">0:00</span>
                <span id="total-time">0:00</span>
            </div>
        </div>
        
        <div class="player-controls">
            <button id="prev-btn" class="control-btn" title="‰∏ä‰∏ÄÈ¶ñ">‚èÆ</button>
            <button id="play-btn" class="control-btn">‚ñ∂ Êí≠Êîæ</button>
            <button id="next-btn" class="control-btn" title="‰∏ã‰∏ÄÈ¶ñ">‚è≠</button>
        </div>
        
        <div class="volume-control">
            <span style="color: #d4af37;">üîä</span>
            <input type="range" id="volume-slider" min="0" max="1" step="0.05" value="0.5">
            <span id="volume-text">50%</span>
        </div>
        
        <div class="song-list" id="song-list">
            <!-- Ê≠åÊõ≤ÂàóË°®‰ºöÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
        </div>
        
        <audio id="christmas-audio" preload="metadata">
            <!-- ÈªòËÆ§Èü≥È¢ëÊ∫ê -->
            <source src="jingle-bells.mp3" type="audio/mpeg">
            ÊÇ®ÁöÑÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ
        </audio>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- Configuration ---
        const PARTICLE_COUNT = 10000; // Â¢ûÂä†Á≤íÂ≠êÊï∞Èáè
        const SNOW_COUNT = 2500;
        
        const COLORS = {
            emerald: new THREE.Color(0x046307),
            darkGreen: new THREE.Color(0x012e03),
            trunk: new THREE.Color(0x4a3728),
            gold: new THREE.Color(0xFFD700),
            red: new THREE.Color(0xFF0033),
            blue: new THREE.Color(0x0066FF),
            white: new THREE.Color(0xFFFFFF)
        };

        // --- State Management ---
        const state = {
            mode: 'tree', // tree, text, heart, explode
            mousePosition: new THREE.Vector3(0, 0, 0),
            targetMousePosition: new THREE.Vector3(0, 0, 0),
            time: 0,
            clickCounter: 0 // 0:tree, 1:text, 2:heart, 3:explode, then back to 0
        };

        // --- Init Scene ---
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000500, 0.015);
        
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 0, 22);

        // --- Post Processing (Bloom) ---
        const renderScene = new RenderPass(scene, camera);
        const bloomPass = new UnrealBloomPass(
            new THREE.Vector2(window.innerWidth, window.innerHeight), 
            1.6, 0.4, 0.85
        );
        bloomPass.threshold = 0.1;
        bloomPass.strength = 1.6;
        bloomPass.radius = 0.7;
        
        const composer = new EffectComposer(renderer);
        composer.addPass(renderScene);
        composer.addPass(bloomPass);

        // --- Particle System ---
        const geometry = new THREE.BufferGeometry();
        const positions = new Float32Array(PARTICLE_COUNT * 3);
        const colors = new Float32Array(PARTICLE_COUNT * 3);
        const sizes = new Float32Array(PARTICLE_COUNT);
        const targetPositions = new Float32Array(PARTICLE_COUNT * 3);

        // Initialize particles
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const x = (Math.random() - 0.5) * 30;
            const y = (Math.random() - 0.5) * 30;
            const z = (Math.random() - 0.5) * 20;
            
            positions[i*3] = x;
            positions[i*3+1] = y;
            positions[i*3+2] = z;
            
            targetPositions[i*3] = x;
            targetPositions[i*3+1] = y;
            targetPositions[i*3+2] = z;
            
            sizes[i] = Math.random();
        }

        geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
        geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

        // Shader Material
        const material = new THREE.ShaderMaterial({
            uniforms: {
                pointTexture: { 
                    value: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/spark1.png') 
                },
                uTime: { value: 0 },
                uPixelRatio: { value: renderer.getPixelRatio() },
                uMouseEffect: { value: 0.0 }
            },
            vertexShader: `
                attribute float size;
                attribute vec3 color;
                varying vec3 vColor;
                uniform float uTime;
                uniform float uPixelRatio;
                uniform float uMouseEffect;
                
                void main() {
                    vColor = color;
                    vec3 pos = position;
                    
                    // Wind/Breath effect
                    float wave = sin(uTime * 1.5 + pos.y * 0.2) * 0.08;
                    pos.x += wave;
                    
                    // Mouse interaction effect
                    float mouseWave = sin(uTime * 3.0 + pos.x * 0.3 + pos.y * 0.2) * uMouseEffect * 0.3;
                    pos.y += mouseWave;
                    
                    vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
                    gl_PointSize = size * (220.0 / -mvPosition.z) * uPixelRatio;
                    gl_Position = projectionMatrix * mvPosition;
                }
            `,
            fragmentShader: `
                uniform sampler2D pointTexture;
                varying vec3 vColor;
                
                void main() {
                    vec4 texColor = texture2D(pointTexture, gl_PointCoord);
                    gl_FragColor = vec4(vColor, 1.0) * texColor;
                    
                    // Add glow effect
                    float alpha = texColor.a;
                    float glow = smoothstep(0.0, 0.5, texColor.r);
                    gl_FragColor.rgb += vColor * glow * 0.3;
                    
                    if (gl_FragColor.a < 0.15) discard;
                }
            `,
            depthWrite: false,
            blending: THREE.AdditiveBlending,
            transparent: true
        });

        const particleSystem = new THREE.Points(geometry, material);
        scene.add(particleSystem);

        // --- Snow System ---
        const snowGeo = new THREE.BufferGeometry();
        const snowPos = new Float32Array(SNOW_COUNT * 3);
        for(let i = 0; i < SNOW_COUNT; i++) {
            snowPos[i*3] = (Math.random() - 0.5) * 60;
            snowPos[i*3+1] = (Math.random() - 0.5) * 40 + 15;
            snowPos[i*3+2] = (Math.random() - 0.5) * 40;
        }
        snowGeo.setAttribute('position', new THREE.BufferAttribute(snowPos, 3));
        
        const snowMat = new THREE.PointsMaterial({
            color: 0xffffff,
            size: 0.18,
            transparent: true,
            opacity: 0.8,
            blending: THREE.AdditiveBlending,
            map: new THREE.TextureLoader().load('https://threejs.org/examples/textures/sprites/snowflake2.png')
        });
        
        const snowSystem = new THREE.Points(snowGeo, snowMat);
        scene.add(snowSystem);

        // --- Helper Functions ---
        function setColor(index, color) {
            colors[index*3] = color.r;
            colors[index*3+1] = color.g;
            colors[index*3+2] = color.b;
        }

        function updateAttributes() {
            geometry.attributes.color.needsUpdate = true;
            geometry.attributes.size.needsUpdate = true;
        }

        function updateStateText() {
            const stateText = document.getElementById('state-text');
            const states = {
                'tree': 'Christmas Tree',
                'text': 'Merry Christmas Text',
                'heart': '3D Heart',
                'explode': 'Explosion'
            };
            stateText.textContent = states[state.mode];
            stateText.style.color = state.mode === 'explode' ? '#FF3333' : 
                                  state.mode === 'heart' ? '#FF66AA' :
                                  state.mode === 'text' ? '#FFD700' : '#4CAF50';
        }

        // --- Shape Functions ---
        
        // 1. Christmas Tree
        function generateTreeTargets() {
            let i = 0;
            const treeHeight = 15;
            const treeRadius = 7;
            const leafCount = Math.floor(PARTICLE_COUNT * 0.82); // 82% for leaves
            
            // Tree leaves (cone shape)
            for (; i < leafCount; i++) {
                const percent = i / leafCount;
                const y = treeHeight/2 - percent * treeHeight;
                const r = percent * treeRadius;
                const theta = Math.random() * Math.PI * 2 * 12; // More spirals
                
                // Cone shape with volume
                const rVol = r * Math.sqrt(Math.random()); 
                targetPositions[i*3] = rVol * Math.cos(theta);
                targetPositions[i*3+1] = y;
                targetPositions[i*3+2] = rVol * Math.sin(theta);
                
                // Ornaments (12% chance)
                const isOrnament = Math.random() > 0.88;
                if(isOrnament) {
                    const rand = Math.random();
                    if(rand < 0.3) setColor(i, COLORS.red);
                    else if(rand < 0.6) setColor(i, COLORS.gold);
                    else if(rand < 0.8) setColor(i, COLORS.blue);
                    else setColor(i, COLORS.white);
                    sizes[i] = Math.random() * 0.8 + 0.6;
                } else {
                    // Green gradient
                    const greenColor = COLORS.emerald.clone().lerp(
                        COLORS.darkGreen, 
                        Math.pow(Math.random(), 1.5)
                    );
                    setColor(i, greenColor);
                    sizes[i] = Math.random() * 0.4 + 0.15;
                }
            }
            
            // Tree trunk (remaining particles)
            const trunkCount = PARTICLE_COUNT - i;
            for (let j = 0; j < trunkCount; j++, i++) {
                const r = Math.random() * 1.0;
                const y = -treeHeight/2 - Math.random() * 3.0;
                const theta = Math.random() * Math.PI * 2;
                
                targetPositions[i*3] = r * Math.cos(theta);
                targetPositions[i*3+1] = y;
                targetPositions[i*3+2] = r * Math.sin(theta);
                
                setColor(i, COLORS.trunk);
                sizes[i] = 0.35 + Math.random() * 0.2;
            }
            
            state.mode = 'tree';
            updateAttributes();
            updateStateText();
            document.getElementById('loading').style.display = 'none';
        }

        // 2. Improved "Merry Christmas" Text
        const textCanvas = document.createElement('canvas');
        const ctx = textCanvas.getContext('2d');
        textCanvas.width = 800;
        textCanvas.height = 200;
        let textPoints = [];
        
        function initText() {
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 800, 200);
            
            // ‰ΩøÁî®Êõ¥Â§ßÁöÑÂ≠ó‰ΩìÂíåÊõ¥ÂÆΩÁöÑÈó¥Ë∑ùÁ°Æ‰øùÊñáÂ≠óÂÆåÊï¥ÊòæÁ§∫
            ctx.font = 'bold 80px "Cinzel"';
            ctx.fillStyle = '#ffffff';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText("Merry Christmas", 400, 100);
            
            // Ëé∑ÂèñÂÉèÁ¥†Êï∞ÊçÆ
            const imageData = ctx.getImageData(0, 0, 800, 200);
            const data = imageData.data;
            textPoints = [];
            
            // Êõ¥ÂØÜÈõÜÁöÑÈááÊ†∑Á°Æ‰øùÊñáÂ≠óÂÆåÊï¥
            for (let y = 0; y < 200; y += 1.5) {
                for (let x = 0; x < 800; x += 1.5) {
                    const idx = (Math.floor(y) * 800 + Math.floor(x)) * 4;
                    if (data[idx] > 128) {
                        textPoints.push({
                            x: (x - 400) * 0.04, // Ë∞ÉÊï¥Áº©ÊîæÊØî‰æã
                            y: -(y - 100) * 0.04
                        });
                    }
                }
            }
        }
        
        initText();
        
        function generateTextTargets() {
            // ÂàÜÈÖçÁ≤íÂ≠êÂà∞ÊñáÂ≠ó
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                if (i < textPoints.length) { 
                    const p = textPoints[i];
                    targetPositions[i*3] = p.x + (Math.random()-0.5)*0.05;
                    targetPositions[i*3+1] = p.y + (Math.random()-0.5)*0.05;
                    targetPositions[i*3+2] = (Math.random()-0.5) * 0.3;
                    
                    // ÈáëËâ≤Âà∞ÁôΩËâ≤ÁöÑÊ∏êÂèò
                    const colorMix = Math.random();
                    const textColor = colorMix < 0.7 ? 
                        COLORS.gold : 
                        COLORS.gold.clone().lerp(COLORS.white, Math.random());
                    setColor(i, textColor);
                    sizes[i] = 0.5 + Math.random() * 0.3;
                } else {
                    // ÈáçÂ§ç‰ΩøÁî®ÊñáÂ≠óÁÇπÔºåÁ°Æ‰øùÊâÄÊúâÁ≤íÂ≠êÈÉΩÊúâ‰ΩçÁΩÆ
                    const p = textPoints[i % textPoints.length];
                    const offset = Math.floor(i / textPoints.length) * 0.1;
                    
                    targetPositions[i*3] = p.x + (Math.random()-0.5)*0.05 + offset;
                    targetPositions[i*3+1] = p.y + (Math.random()-0.5)*0.05;
                    targetPositions[i*3+2] = (Math.random()-0.5) * 0.5;
                    
                    // ‰∏çÂêåÂ±ÇÁöÑÈ¢úËâ≤ÂèòÂåñ
                    const layer = Math.floor(i / textPoints.length);
                    const layerColor = layer % 3 === 0 ? COLORS.gold :
                                      layer % 3 === 1 ? COLORS.red :
                                      COLORS.blue;
                    setColor(i, layerColor.clone().lerp(COLORS.white, Math.random()*0.3));
                    sizes[i] = 0.4 + Math.random() * 0.3;
                }
            }
            
            state.mode = 'text';
            updateAttributes();
            updateStateText();
        }

        // 3. Improved 3D Heart
        function generateHeartTargets() {
            // ÊîπËøõÁöÑÂøÉÂΩ¢ÂÖ¨ÂºèÔºåÁ≤íÂ≠êÂàÜÂ∏ÉÊõ¥ÂùáÂåÄ
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                // ÂèÇÊï∞ÂåñÂøÉÂΩ¢ÔºåÊõ¥ÂùáÂåÄÁöÑÈááÊ†∑
                const t = Math.random() * Math.PI * 2;
                const r = Math.sqrt(Math.random()); // ÂùáÂåÄÂàÜÂ∏É
                
                // 3DÂøÉÂΩ¢ÂÖ¨Âºè
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                const z = Math.sin(t * 2) * 2; // Ê∑ªÂä†Ê∑±Â∫¶
                
                const scale = 0.5;
                targetPositions[i*3] = x * scale * r + (Math.random()-0.5)*0.2;
                targetPositions[i*3+1] = y * scale * r + 1.5; 
                targetPositions[i*3+2] = z * scale * r * 0.7 + (Math.random()-0.5)*0.5;
                
                // Á∫¢Ëâ≤Âà∞Á≤âËâ≤ÁöÑÊ∏êÂèòÔºå‰∏≠ÂøÉÊõ¥‰∫Æ
                const distFromCenter = Math.sqrt(x*x + y*y) * scale;
                const colorFactor = Math.min(1.0, distFromCenter / 8.0);
                
                const heartColor = new THREE.Color().lerpColors(
                    new THREE.Color(0xFF3366), // ‰∫ÆÁ∫¢
                    new THREE.Color(0xFF99CC), // Á≤âÁ∫¢
                    colorFactor * 0.7
                );
                
                // Ê∑ªÂä†‰∏Ä‰∫õÈáëËâ≤‰∫ÆÁÇπ
                if (Math.random() > 0.85) {
                    heartColor.lerp(COLORS.gold, 0.6);
                }
                
                setColor(i, heartColor);
                sizes[i] = 0.5 + Math.random() * 0.4;
            }
            
            state.mode = 'heart';
            updateAttributes();
            updateStateText();
        }

        // 4. Explosion
        function generateExplodeTargets() {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                // ÁêÉÂΩ¢ÁàÜÁÇ∏ÔºåÁ≤íÂ≠êÂêëÂ§ñÊâ©Êï£
                const r = 5 + Math.random() * 25;
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                
                targetPositions[i*3] = r * Math.sin(phi) * Math.cos(theta);
                targetPositions[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                targetPositions[i*3+2] = r * Math.cos(phi);
                
                // ÁàÜÁÇ∏È¢úËâ≤ÔºöÈáëËâ≤ -> Á∫¢Ëâ≤ -> ÁôΩËâ≤
                const colorRand = Math.random();
                let explodeColor;
                if (colorRand < 0.4) {
                    explodeColor = COLORS.gold;
                } else if (colorRand < 0.7) {
                    explodeColor = COLORS.red;
                } else {
                    explodeColor = COLORS.white;
                }
                
                // Ê†πÊçÆË∑ùÁ¶ªÊ∑ªÂä†Ê∏êÂèò
                explodeColor = explodeColor.clone().lerp(
                    COLORS.white, 
                    Math.min(1.0, r / 20)
                );
                
                setColor(i, explodeColor);
                sizes[i] = 0.3 + Math.random() * 0.4;
            }
            
            state.mode = 'explode';
            updateAttributes();
            updateStateText();
        }

        // --- Interaction Logic ---
        
        // Mouse Move
        window.addEventListener('mousemove', (e) => {
            const mouseX = (e.clientX / window.innerWidth) * 2 - 1;
            const mouseY = -(e.clientY / window.innerHeight) * 2 + 1;
            
            const vector = new THREE.Vector3(mouseX, mouseY, 0.5);
            vector.unproject(camera);
            const dir = vector.sub(camera.position).normalize();
            const distance = -camera.position.z / dir.z;
            const pos = camera.position.clone().add(dir.multiplyScalar(distance));
            
            state.targetMousePosition.copy(pos);
            state.targetMousePosition.x *= 0.7;
            state.targetMousePosition.y *= 0.7;
            state.targetMousePosition.z *= 0.5;
            
            // Èº†Ê†á‰∫íÂä®ÊïàÊûú
            material.uniforms.uMouseEffect.value = 0.5;
        });

        // Mouse Leave
        window.addEventListener('mouseout', () => {
            material.uniforms.uMouseEffect.value = 0.0;
        });

        // Click Logic - Âæ™ÁéØÁä∂ÊÄÅ
        window.addEventListener('click', (e) => {
            // ÁÇπÂáªÂèçÈ¶àÂä®Áîª
            const ripple = document.createElement('div');
            ripple.className = 'click-hint';
            ripple.style.left = e.clientX + 'px';
            ripple.style.top = e.clientY + 'px';
            document.body.appendChild(ripple);
            setTimeout(() => ripple.remove(), 600);
            
            // Áä∂ÊÄÅÂæ™ÁéØ
            state.clickCounter = (state.clickCounter + 1) % 4;
            
            switch(state.clickCounter) {
                case 0:
                    generateTreeTargets();
                    break;
                case 1:
                    generateTextTargets();
                    break;
                case 2:
                    generateHeartTargets();
                    break;
                case 3:
                    generateExplodeTargets();
                    break;
            }
        });

        // Initialize with Tree
        generateTreeTargets();

        // --- Animation Loop ---
        const clock = new THREE.Clock();
        
        function animate() {
            requestAnimationFrame(animate);
            const dt = clock.getDelta();
            state.time += dt;
            
            // Update uniforms
            material.uniforms.uTime.value = state.time;
            
            // Smooth mouse follow
            state.mousePosition.lerp(state.targetMousePosition, 0.05);
            
            // Gradually reduce mouse effect
            if (material.uniforms.uMouseEffect.value > 0) {
                material.uniforms.uMouseEffect.value *= 0.95;
            }
            
            // Particle movement to target positions
            const posArr = geometry.attributes.position.array;
            const speed = state.mode === 'explode' ? 0.12 : 
                         state.mode === 'heart' ? 0.06 : 0.04;
            
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const tx = targetPositions[i*3] + state.mousePosition.x;
                const ty = targetPositions[i*3+1] + state.mousePosition.y;
                const tz = targetPositions[i*3+2] + state.mousePosition.z;
                
                posArr[i*3] += (tx - posArr[i*3]) * speed;
                posArr[i*3+1] += (ty - posArr[i*3+1]) * speed;
                posArr[i*3+2] += (tz - posArr[i*3+2]) * speed;
            }
            geometry.attributes.position.needsUpdate = true;
            
            // Snow animation
            const snowPosArr = snowGeo.attributes.position.array;
            for(let i = 0; i < SNOW_COUNT; i++) {
                snowPosArr[i*3+1] -= 0.05;
                snowPosArr[i*3] += Math.sin(state.time * 0.5 + snowPosArr[i*3+1] * 0.05) * 0.03;
                
                if (snowPosArr[i*3+1] < -25) {
                    snowPosArr[i*3+1] = 25;
                    snowPosArr[i*3] = (Math.random() - 0.5) * 60;
                    snowPosArr[i*3+2] = (Math.random() - 0.5) * 40;
                }
            }
            snowGeo.attributes.position.needsUpdate = true;
            
            composer.render();
        }
        
        animate();

        // Resize handling
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            composer.setSize(window.innerWidth, window.innerHeight);
            
            // Update text canvas size on resize
            textCanvas.width = Math.min(800, window.innerWidth);
            textCanvas.height = Math.min(200, window.innerHeight * 0.2);
            initText();
        });

        // Hide loading text after a short delay
        setTimeout(() => {
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 500);
        }, 1500);
    </script>

    <!-- Èü≥‰πêÊí≠ÊîæÂô®ÂäüËÉΩËÑöÊú¨ -->
    <script>
        // Á≠âÂæÖÈ°µÈù¢Âä†ËΩΩÂÆåÊàê
        document.addEventListener('DOMContentLoaded', function() {
            // Èü≥‰πêÊí≠ÊîæÂô®ÂÖÉÁ¥†
            const audio = document.getElementById('christmas-audio');
            const playBtn = document.getElementById('play-btn');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const volumeSlider = document.getElementById('volume-slider');
            const volumeText = document.getElementById('volume-text');
            const songTitle = document.getElementById('song-title');
            const progressBar = document.getElementById('progress-bar');
            const currentTimeEl = document.getElementById('current-time');
            const totalTimeEl = document.getElementById('total-time');
            const songList = document.getElementById('song-list');
            const togglePlayer = document.getElementById('toggle-player');
            const musicPlayer = document.getElementById('music-player');
            const closePlayer = document.getElementById('close-player');
            
            // ÈªòËÆ§Ê≠åÊõ≤ÂàóË°® - ËØ∑Ê†πÊçÆÊÇ®ÂÆûÈôÖÁöÑÊñá‰ª∂Âêç‰øÆÊîπ
            const songs = [
                { 
                    title: "JAshanti - We Wish You A Merry Christmas", 
                    file: "Ashanti - We Wish You A Merry Christmas.mp3",
                    artist: "Ashanti ",
                    duration: "01:35"
                },
                { 
                    title: "Mariah Carey - All I Want for Christmas Is You", 
                    file: "Mariah Carey - All I Want for Christmas Is You.mp3",
                    artist: "Mariah Carey",
                    duration: "04:01"
                },
                { 
                    title: "Wham! - Last Christmas", 
                    file: "Wham! - Last Christmas.mp3", 
                    artist: "Wham!",
                    duration: "04:29"
                }
              
            ];
            
            let currentSongIndex = 0;
            
            // ÂàùÂßãÂåñÊ≠åÊõ≤ÂàóË°®
            function initializeSongList() {
                songList.innerHTML = '';
                songs.forEach((song, index) => {
                    const songItem = document.createElement('div');
                    songItem.className = `song-item ${index === currentSongIndex ? 'active' : ''}`;
                    songItem.innerHTML = `
                        <div style="font-weight: ${index === currentSongIndex ? 'bold' : 'normal'}">
                            ${song.title}
                        </div>
                        <div style="font-size: 0.8rem; color: rgba(255,255,255,0.6)">
                            ${song.artist} ‚Ä¢ ${song.duration}
                        </div>
                    `;
                    songItem.addEventListener('click', () => {
                        currentSongIndex = index;
                        loadSong(currentSongIndex);
                        updateSongList();
                    });
                    songList.appendChild(songItem);
                });
            }
            
            // Êõ¥Êñ∞Ê≠åÊõ≤ÂàóË°®È´ò‰∫Æ
            function updateSongList() {
                const items = songList.querySelectorAll('.song-item');
                items.forEach((item, index) => {
                    if (index === currentSongIndex) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
            }
            
            // Âä†ËΩΩÊ≠åÊõ≤
            function loadSong(index) {
                if (index >= 0 && index < songs.length) {
                    audio.src = songs[index].file;
                    songTitle.textContent = `Ê≠£Âú®Êí≠ÊîæÔºö${songs[index].title}`;
                    
                    // Êõ¥Êñ∞ÊÄªÊó∂Èó¥ÊòæÁ§∫
                    audio.addEventListener('loadedmetadata', function() {
                        totalTimeEl.textContent = formatTime(audio.duration);
                    }, { once: true });
                    
                    // Êí≠ÊîæÊ≠åÊõ≤
                    audio.play().then(() => {
                        playBtn.innerHTML = "‚è∏ ÊöÇÂÅú";
                        playBtn.style.background = "#c62828";
                    }).catch(e => {
                        console.log("Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢");
                        playBtn.innerHTML = "‚ñ∂ Êí≠Êîæ";
                        playBtn.style.background = "#d4af37";
                    });
                    
                    updateSongList();
                }
            }
            
            // Êó∂Èó¥Ê†ºÂºèÂåñ
            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
            
            // Êí≠Êîæ/ÊöÇÂÅúÊåâÈíÆ
            playBtn.addEventListener('click', function() {
                if (audio.paused) {
                    audio.play();
                    playBtn.innerHTML = "‚è∏ ÊöÇÂÅú";
                    playBtn.style.background = "#c62828";
                } else {
                    audio.pause();
                    playBtn.innerHTML = "‚ñ∂ Êí≠Êîæ";
                    playBtn.style.background = "#d4af37";
                }
            });
            
            // ‰∏ä‰∏ÄÈ¶ñÊåâÈíÆ
            prevBtn.addEventListener('click', function() {
                currentSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
                loadSong(currentSongIndex);
            });
            
            // ‰∏ã‰∏ÄÈ¶ñÊåâÈíÆ
            nextBtn.addEventListener('click', function() {
                currentSongIndex = (currentSongIndex + 1) % songs.length;
                loadSong(currentSongIndex);
            });
            
            // Èü≥ÈáèÊéßÂà∂
            volumeSlider.addEventListener('input', function() {
                audio.volume = this.value;
                volumeText.textContent = Math.round(this.value * 100) + "%";
            });
            
            // ÂàùÂßãÈü≥ÈáèËÆæÁΩÆ
            audio.volume = 0.5;
            
            // Êõ¥Êñ∞ËøõÂ∫¶Êù°
            audio.addEventListener('timeupdate', function() {
                if (audio.duration) {
                    const progress = (audio.currentTime / audio.duration) * 100;
                    progressBar.style.width = `${progress}%`;
                    currentTimeEl.textContent = formatTime(audio.currentTime);
                }
            });
            
            // ÁÇπÂáªËøõÂ∫¶Êù°Ë∑≥ËΩ¨
            document.getElementById('song-progress').addEventListener('click', function(e) {
                const rect = this.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                const percentage = clickX / width;
                
                if (audio.duration) {
                    audio.currentTime = percentage * audio.duration;
                }
            });
            
            // Ê≠åÊõ≤Êí≠ÊîæÁªìÊùüËá™Âä®‰∏ã‰∏ÄÈ¶ñ
            audio.addEventListener('ended', function() {
                nextBtn.click();
            });
            
            // Êí≠ÊîæÂô®ÊòæÁ§∫/ÈöêËóèÊéßÂà∂
            togglePlayer.addEventListener('click', function() {
                musicPlayer.classList.toggle('player-hidden');
            });
            
            closePlayer.addEventListener('click', function() {
                musicPlayer.classList.add('player-hidden');
            });
            
            // ÂàùÂßãÂåñ
            initializeSongList();
            loadSong(currentSongIndex);
            
            // È¶ñÊ¨°ÁÇπÂáªÈ°µÈù¢Êó∂ÊòæÁ§∫Êí≠ÊîæÂô®Âπ∂Êí≠ÊîæÈü≥‰πê
            let firstClick = true;
            document.addEventListener('click', function initAudio(e) {
                // Â¶ÇÊûúÁÇπÂáªÁöÑ‰∏çÊòØÊí≠ÊîæÂô®ÂÜÖÈÉ®ÂÖÉÁ¥†ÔºåÂàôÂàùÂßãÂåñ
                if (!musicPlayer.contains(e.target) && e.target !== togglePlayer) {
                    if (firstClick) {
                        // ÊòæÁ§∫Êí≠ÊîæÂô®
                        musicPlayer.classList.remove('player-hidden');
                        
                        // Êí≠ÊîæÈü≥‰πê
                        audio.play().then(() => {
                            playBtn.innerHTML = "‚è∏ ÊöÇÂÅú";
                            playBtn.style.background = "#c62828";
                        }).catch(e => {
                            console.log("Ëá™Âä®Êí≠ÊîæË¢´ÈòªÊ≠¢ÔºåËØ∑ÁÇπÂáªÊí≠ÊîæÊåâÈíÆ");
                            playBtn.innerHTML = "‚ñ∂ Êí≠Êîæ";
                            playBtn.style.background = "#d4af37";
                        });
                        
                        firstClick = false;
                    }
                }
            }, { once: false }); // ‰∏çÂÜçÂè™ÊâßË°å‰∏ÄÊ¨°ÔºåÂÖÅËÆ∏ÂêéÁª≠ÁÇπÂáª
        });
    </script>
</body>
</html>